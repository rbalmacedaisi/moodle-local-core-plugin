define("local_grupomakro_core/delete_class", ["core/ajax", "jquery"], (function (Ajax, $) {
    "use strict";

    var selectedClassIds = [];

    var handleViewToggle = function () {
        var gridBtn = $('#btn-grid-view');
        var listBtn = $('#btn-list-view');
        var gridView = $('#class-grid-view');
        var listView = $('#class-list-view');

        if (!gridBtn.length || !listBtn.length || !gridView.length || !listView.length) {
            window.console.warn("GMK DEBUG: View toggle elements missing from DOM");
            return;
        }

        var savedView = localStorage.getItem("classManagementView") || "grid";

        var applyView = function (viewType) {
            window.console.log("GMK DEBUG: setView -> " + viewType);
            if (viewType === 'grid') {
                gridBtn.addClass('active');
                listBtn.removeClass('active');
                gridView.removeClass('d-none');
                listView.addClass('d-none');
                localStorage.setItem('classManagementView', 'grid');
            } else {
                listBtn.addClass('active');
                gridBtn.removeClass('active');
                listView.removeClass('d-none');
                gridView.addClass('d-none');
                localStorage.setItem('classManagementView', 'list');
            }
        };

        applyView(savedView);

        $(document).on('click', '#btn-grid-view', function (e) {
            e.preventDefault();
            applyView('grid');
        });

        $(document).on('click', '#btn-list-view', function (e) {
            e.preventDefault();
            applyView('list');
        });
    };

    var handleBulkDelete = function () {
        $(document).on('change', '#selectAllClasses', function (e) {
            var checked = $(this).is(':checked');
            $('.class-checkbox').prop('checked', checked);
            updateSelected();
        });

        $(document).on('change', '.class-checkbox', function () {
            updateSelected();
            var all = $('.class-checkbox').length;
            var checkedCount = $('.class-checkbox:checked').length;
            $('#selectAllClasses').prop('checked', all === checkedCount);
        });

        $(document).on('click', '.deleteButton', function () {
            selectedClassIds = [$(this).attr('class-id')];
        });

        $(document).on('click', '#confirmDeleteButton', function () {
            if (selectedClassIds.length === 0) return;
            var requests = selectedClassIds.map(function (id) {
                return { methodname: 'local_grupomakro_delete_class', args: { id: id } };
            });
            Ajax.call(requests)[0].done(function () {
                window.location.reload();
            }).fail(function (e) {
                window.console.error(e);
            });
        });
    };

    var updateSelected = function () {
        selectedClassIds = [];
        $('.class-checkbox:checked').each(function () {
            selectedClassIds.push($(this).val());
        });
        if (selectedClassIds.length > 0) {
            $('#bulkDeleteButton').removeClass('d-none');
        } else {
            $('#bulkDeleteButton').addClass('d-none');
        }
    };

    return {
        init: function () {
            window.console.log("GMK DEBUG: delete_class.min.js init() starting...");
            handleViewToggle();
            handleBulkDelete();
            window.console.log("GMK DEBUG: init() complete.");
        }
    };
}));