{"version":3,"file":"contract_enrol.min.js","sources":["../src/contract_enrol.js"],"sourcesContent":["import * as Ajax from 'core/ajax';\nimport $ from 'jquery';\n\nconst errorModal = $('#errorModal');\nconst errorModalContent = $('#error-modal-content');\n\nconst documentCheckInputHolder = $('#document-check-input');\nconst userCheckIdentificationNumberInput = $('#userCheckIdentificationNumber');\nconst enrolButton = $('#enrolButton');\nconst userNotFoundModal = $('#userNotFoundModal');\nconst enrolCreateAccountButton = $('#enrolCreateAccountButton');\n\nconst createAccountInputsHolder = $('#create-user-inputs');\nconst createUserIdentificationNumberInput = $('#userIdentificationNumber');\nconst createUserFirstNameInput = $('#userFirstName');\nconst createUserLastNameInput = $('#userLastName');\nconst createUserEmailInput = $('#userEmail');\n\nconst createUserInputs = [createUserIdentificationNumberInput,createUserFirstNameInput,createUserLastNameInput,createUserEmailInput];\n\nlet enrolCourseId,enrolContractId,creatingAccount = false;\nlet webserviceUrl;\n\nconst fetchParams = {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/json',\n        },\n    }\n\nexport const init = async (courseId,contractId,wsUrl) => {\n    webserviceUrl = wsUrl;\n    [enrolCourseId,enrolContractId] = [courseId,contractId];\n    handleEnrolButtonClick();\n    handleEnrolCreateAccountButtonClick()\n};\n\nconst handleEnrolCreateAccountButtonClick = () => {\n    enrolCreateAccountButton.click(()=>{\n        creatingAccount = true;\n        documentCheckInputHolder.hide();\n        createUserIdentificationNumberInput.val(userCheckIdentificationNumberInput.val())\n        userNotFoundModal.modal('hide');\n        createAccountInputsHolder.show();\n    })\n}\n\nconst handleEnrolButtonClick = () => {\n    enrolButton.click(async ()=>{\n        if(!creatingAccount){\n            if(!userCheckIdentificationNumberInput.get(0).reportValidity()) return;\n            const params = new URLSearchParams();\n            params.append('field', 'username');\n            params.append('values[0]', userCheckIdentificationNumberInput.val());\n            try {\n                // First,check if the user exists\n                let response = await window.fetch(webserviceUrl+'core_user_get_users_by_field&'+params, fetchParams)\n                if (!response.ok) {\n                  throw new Error('Request failed with status: ' + response.status);\n                }\n                response = await response.json();\n                if (!response.length) {\n                    userNotFoundModal.modal('show');\n                    return;\n                }\n                return enrolContractUser(response[0].id);\n                \n            \n            } catch (error) {\n                errorModalContent.html(`<p class=\"text-center\">${error.message}</p>`);\n                errorModal.modal('show');\n                console.error(error);\n                \n            } finally{\n                return;\n            }\n        }\n        \n        // Check the create user inputs\n        const valid = createUserInputs.every(input => {\n            return input.get(0).reportValidity();\n        });\n        if (!valid) {\n            return;\n        }\n        const params = new URLSearchParams();\n        params.append('username', createUserIdentificationNumberInput.val());\n        params.append('firstname', createUserFirstNameInput.val());\n        params.append('lastname', createUserLastNameInput.val());\n        params.append('email', createUserEmailInput.val());\n        params.append('contractId',enrolContractId);\n        params.append('courseId', enrolCourseId);\n        try{\n        let response = await window.fetch(webserviceUrl+'local_grupomakro_create_student_user&'+params, fetchParams)\n            if (!response.ok) {\n                throw new Error('Request failed with status: ' + response.status);\n            }\n            response = await response.json();\n            if(response.contractEnrolResult ===-1) throw response.message;\n            setTimeout(()=>{\n                window.location.href = `https://students-lxp-dev.soluttolabs.com/login`\n            },5000)\n            \n        }catch (error){\n            errorModalContent.html(`<p class=\"text-center\">${error}</p>`);\n            errorModal.modal('show');\n            console.error(error);\n        }finally{\n            return;\n        }\n        //\n    })\n} \n\nconst enrolContractUser = async (userId) => {\n    const params = new URLSearchParams();\n    params.append('userId', userId);\n    params.append('contractId', enrolContractId);\n    params.append('courseIds', enrolCourseId);\n    try{\n        let response = await window.fetch(webserviceUrl+'local_grupomakro_create_contract_user&'+params, fetchParams)\n        if (!response.ok) {\n            throw new Error('Request failed with status: ' + response.status);\n        }\n        response = await response.json();\n        if(response.contractUserId ===-1)throw response.message;\n        if(!response.result) throw response.message\n        \n        const parsedResponse = JSON.parse(response.result)\n        \n        if(!parsedResponse.success.length )throw parsedResponse.failure[0].message\n        \n        setTimeout(()=>{\n            window.location.href = `https://students-lxp-dev.soluttolabs.com/login`\n        },5000)\n        \n    }catch (error){\n        errorModalContent.html(`<p class=\"text-center\">${error}</p>`);\n        errorModal.modal('show');\n    }finally{\n        return;\n    }\n    \n}\n"],"names":["enrolCourseId","enrolContractId","webserviceUrl","errorModal","errorModalContent","documentCheckInputHolder","userCheckIdentificationNumberInput","enrolButton","userNotFoundModal","enrolCreateAccountButton","createAccountInputsHolder","createUserIdentificationNumberInput","createUserFirstNameInput","createUserLastNameInput","createUserEmailInput","createUserInputs","creatingAccount","fetchParams","method","headers","init","courseId","contractId","wsUrl","handleEnrolButtonClick","handleEnrolCreateAccountButtonClick","click","hide","val","modal","show","get","reportValidity","params","URLSearchParams","append","window","fetch","response","ok","Error","status","json","length","enrolContractUser","id","html","_context2","message","console","error","every","input","contractEnrolResult","setTimeout","location","href","userId","contractUserId","result","parsedResponse","JSON","parse","success","failure"],"mappings":"i7DAoBIA,cAAcC,gBACdC,mBAlBEC,YAAa,qEAAE,eACfC,mBAAoB,mBAAE,wBAEtBC,0BAA2B,mBAAE,yBAC7BC,oCAAqC,mBAAE,kCACvCC,aAAc,mBAAE,gBAChBC,mBAAoB,mBAAE,sBACtBC,0BAA2B,mBAAE,6BAE7BC,2BAA4B,mBAAE,uBAC9BC,qCAAsC,mBAAE,6BACxCC,0BAA2B,mBAAE,kBAC7BC,yBAA0B,mBAAE,iBAC5BC,sBAAuB,mBAAE,cAEzBC,iBAAmB,CAACJ,oCAAoCC,yBAAyBC,wBAAwBC,sBAE7EE,iBAAkB,EAG9CC,YAAc,CACZC,OAAQ,OACRC,QAAS,gBACW,qBAIfC,sDAAO,iBAAOC,SAASC,WAAWC,4GAC3CrB,cAAgBqB,MACfvB,cAAkCqB,SAApBpB,gBAA6BqB,WAC5CE,yBACAC,oLAGEA,oCAAsC,WACxChB,yBAAyBiB,OAAM,WAC3BV,iBAAkB,EAClBX,yBAAyBsB,OACzBhB,oCAAoCiB,IAAItB,mCAAmCsB,OAC3EpB,kBAAkBqB,MAAM,QACxBnB,0BAA0BoB,WAI5BN,uBAAyB,WAC3BjB,YAAYmB,iDAAM,qKACVV,4CACIV,mCAAmCyB,IAAI,GAAGC,yFACxCC,QAAS,IAAIC,iBACZC,OAAO,QAAS,YACvBF,QAAOE,OAAO,YAAa7B,mCAAmCsB,yCAGrCQ,OAAOC,MAAMnC,cAAc,gCAAgC+B,QAAQhB,wBAApFqB,yBACUC,kCACN,IAAIC,MAAM,+BAAiCF,SAASG,yCAE3CH,SAASI,mBAA1BJ,yBACcK,uCACVnC,kBAAkBqB,MAAM,4EAGrBe,kBAAkBN,SAAS,GAAGO,+DAIrCzC,kBAAkB0C,sCAA+BC,aAAMC,iBACvD7C,WAAW0B,MAAM,QACjBoB,QAAQC,2FAQFnC,iBAAiBoC,OAAM,SAAAC,cAC1BA,MAAMrB,IAAI,GAAGC,8FAKlBC,OAAS,IAAIC,iBACZC,OAAO,WAAYxB,oCAAoCiB,OAC9DK,OAAOE,OAAO,YAAavB,yBAAyBgB,OACpDK,OAAOE,OAAO,WAAYtB,wBAAwBe,OAClDK,OAAOE,OAAO,QAASrB,qBAAqBc,OAC5CK,OAAOE,OAAO,aAAalC,iBAC3BgC,OAAOE,OAAO,WAAYnC,mDAELoC,OAAOC,MAAMnC,cAAc,wCAAwC+B,OAAQhB,yBAA5FqB,0BACcC,kCACJ,IAAIC,MAAM,+BAAiCF,UAASG,yCAE7CH,UAASI,mBACU,KADpCJ,0BACYe,mDAAiCf,UAASU,gBACtDM,YAAW,WACPlB,OAAOmB,SAASC,wDAClB,wFAGFpD,kBAAkB0C,4DAClB3C,WAAW0B,MAAM,QACjBoB,QAAQC,+KAQdN,oEAAoB,kBAAOa,0JACvBxB,OAAS,IAAIC,iBACZC,OAAO,SAAUsB,QACxBxB,OAAOE,OAAO,aAAclC,iBAC5BgC,OAAOE,OAAO,YAAanC,iDAEFoC,OAAOC,MAAMnC,cAAc,yCAAyC+B,OAAQhB,wBAA7FqB,yBACUC,kCACJ,IAAIC,MAAM,+BAAiCF,SAASG,yCAE7CH,SAASI,mBACK,KAD/BJ,yBACYoB,8CAA2BpB,SAASU,mBAC5CV,SAASqB,sCAAcrB,SAASU,oBAE9BY,eAAiBC,KAAKC,MAAMxB,SAASqB,SAExBI,QAAQpB,sCAAciB,eAAeI,QAAQ,GAAGhB,gBAEnEM,YAAW,WACPlB,OAAOmB,SAASC,wDAClB,uFAGFpD,kBAAkB0C,4DAClB3C,WAAW0B,MAAM"}