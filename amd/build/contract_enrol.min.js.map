{"version":3,"file":"contract_enrol.min.js","sources":["../src/contract_enrol.js"],"sourcesContent":["import $ from 'jquery';\n\nconst errorModal = $('#errorModal');\nconst errorModalContent = $('#error-modal-content');\n\nconst documentCheckInputHolder = $('#document-check-input');\nconst userCheckIdentificationNumberInput = $('#userCheckIdentificationNumber');\nconst enrolButton = $('#enrolButton');\nconst userNotFoundModal = $('#userNotFoundModal');\nconst enrolCreateAccountButton = $('#enrolCreateAccountButton');\n\nconst createAccountInputsHolder = $('#create-user-inputs');\nconst createUserIdentificationNumberInput = $('#userIdentificationNumber');\nconst createUserFirstNameInput = $('#userFirstName');\nconst createUserLastNameInput = $('#userLastName');\nconst createUserEmailInput = $('#userEmail');\n\nconst createUserInputs = [createUserIdentificationNumberInput, createUserFirstNameInput,\n    createUserLastNameInput, createUserEmailInput];\n\nlet enrolCourseId, enrolContractId,\ncreatingAccount = false;\nlet webserviceUrl;\n\nconst fetchParams = {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/json',\n        },\n    };\n\nexport const init = async(courseId, contractId, wsUrl) => {\n    webserviceUrl = wsUrl;\n    [enrolCourseId, enrolContractId] = [courseId, contractId];\n    handleEnrolButtonClick();\n    handleEnrolCreateAccountButtonClick();\n};\n\nconst handleEnrolCreateAccountButtonClick = () => {\n    enrolCreateAccountButton.click(()=>{\n        creatingAccount = true;\n        documentCheckInputHolder.hide();\n        createUserIdentificationNumberInput.val(userCheckIdentificationNumberInput.val());\n        userNotFoundModal.modal('hide');\n        createAccountInputsHolder.show();\n    });\n};\n\nconst handleEnrolButtonClick = () => {\n    enrolButton.click(async()=>{\n        if (!creatingAccount) {\n            if (!userCheckIdentificationNumberInput.get(0).reportValidity()) {\n return;\n}\n            const params = new URLSearchParams();\n            params.append('field', 'username');\n            params.append('values[0]', userCheckIdentificationNumberInput.val());\n            try {\n                // First,check if the user exists\n                let response = await window.fetch(webserviceUrl + 'core_user_get_users_by_field&' + params, fetchParams);\n                if (!response.ok) {\n                  throw new Error('Request failed with status: ' + response.status);\n                }\n                response = await response.json();\n                if (!response.length) {\n                    userNotFoundModal.modal('show');\n                    return;\n                }\n                enrolContractUser(response[0].id);\n\n\n            } catch (error) {\n                errorModalContent.html(`<p class=\"text-center\">${error.message}</p>`);\n                errorModal.modal('show');\n                console.error(error);\n\n            }\n        }\n\n        // Check the create user inputs\n        const valid = createUserInputs.every(input => {\n            return input.get(0).reportValidity();\n        });\n        if (!valid) {\n            return;\n        }\n        const params = new URLSearchParams();\n        params.append('username', createUserIdentificationNumberInput.val());\n        params.append('firstname', createUserFirstNameInput.val());\n        params.append('lastname', createUserLastNameInput.val());\n        params.append('email', createUserEmailInput.val());\n        params.append('contractId', enrolContractId);\n        params.append('courseId', enrolCourseId);\n        try {\n        let response = await window.fetch(webserviceUrl + 'local_grupomakro_create_student_user&' + params, fetchParams);\n            if (!response.ok) {\n                throw new Error('Request failed with status: ' + response.status);\n            }\n            response = await response.json();\n            if (response.contractEnrolResult === -1) {\n throw response.message;\n}\n            setTimeout(()=>{\n                window.location.href = `https://students-lxp-dev.soluttolabs.com/login`;\n            }, 5000);\n\n        } catch (error) {\n            errorModalContent.html(`<p class=\"text-center\">${error}</p>`);\n            errorModal.modal('show');\n            console.error(error);\n        }\n        //\n    });\n};\n\nconst enrolContractUser = async(userId) => {\n    const params = new URLSearchParams();\n    params.append('userId', userId);\n    params.append('contractId', enrolContractId);\n    params.append('courseIds', enrolCourseId);\n    try {\n        let response = await window.fetch(webserviceUrl + 'local_grupomakro_create_contract_user&' + params, fetchParams);\n        if (!response.ok) {\n            throw new Error('Request failed with status: ' + response.status);\n        }\n        response = await response.json();\n        if (response.contractUserId === -1) {\n throw response.message;\n}\n        if (!response.result) {\n throw response.message;\n}\n\n        const parsedResponse = JSON.parse(response.result);\n\n        if (!parsedResponse.success.length) {\n throw parsedResponse.failure[0].message;\n}\n\n        setTimeout(()=>{\n            window.location.href = `https://students-lxp-dev.soluttolabs.com/login`;\n        }, 5000);\n\n    } catch (error) {\n        errorModalContent.html(`<p class=\"text-center\">${error}</p>`);\n        errorModal.modal('show');\n    }\n\n};\n"],"names":["errorModal","errorModalContent","documentCheckInputHolder","userCheckIdentificationNumberInput","enrolButton","userNotFoundModal","enrolCreateAccountButton","createAccountInputsHolder","createUserIdentificationNumberInput","createUserFirstNameInput","createUserLastNameInput","createUserEmailInput","createUserInputs","enrolCourseId","enrolContractId","webserviceUrl","creatingAccount","fetchParams","method","headers","async","courseId","contractId","wsUrl","handleEnrolButtonClick","handleEnrolCreateAccountButtonClick","click","hide","val","modal","show","get","reportValidity","params","URLSearchParams","append","response","window","fetch","ok","Error","status","json","length","enrolContractUser","id","error","html","message","console","every","input","contractEnrolResult","setTimeout","location","href","userId","contractUserId","result","parsedResponse","JSON","parse","success","failure"],"mappings":"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"}