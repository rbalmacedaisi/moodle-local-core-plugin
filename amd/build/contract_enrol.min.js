define("local_grupomakro_core/contract_enrol",["exports","jquery"],(function(_exports,_jquery){var obj;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;const errorModal=(0,(_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj}).default)("#errorModal"),errorModalContent=(0,_jquery.default)("#error-modal-content"),documentCheckInputHolder=(0,_jquery.default)("#document-check-input"),userCheckIdentificationNumberInput=(0,_jquery.default)("#userCheckIdentificationNumber"),enrolButton=(0,_jquery.default)("#enrolButton"),userNotFoundModal=(0,_jquery.default)("#userNotFoundModal"),enrolCreateAccountButton=(0,_jquery.default)("#enrolCreateAccountButton"),createAccountInputsHolder=(0,_jquery.default)("#create-user-inputs"),createUserIdentificationNumberInput=(0,_jquery.default)("#userIdentificationNumber"),createUserFirstNameInput=(0,_jquery.default)("#userFirstName"),createUserLastNameInput=(0,_jquery.default)("#userLastName"),createUserEmailInput=(0,_jquery.default)("#userEmail"),createUserInputs=[createUserIdentificationNumberInput,createUserFirstNameInput,createUserLastNameInput,createUserEmailInput];let enrolCourseId,enrolContractId,webserviceUrl,creatingAccount=!1;const fetchParams={method:"POST",headers:{"Content-Type":"application/json"}};_exports.init=async(courseId,contractId,wsUrl)=>{webserviceUrl=wsUrl,[enrolCourseId,enrolContractId]=[courseId,contractId],handleEnrolButtonClick(),handleEnrolCreateAccountButtonClick()};const handleEnrolCreateAccountButtonClick=()=>{enrolCreateAccountButton.click((()=>{creatingAccount=!0,documentCheckInputHolder.hide(),createUserIdentificationNumberInput.val(userCheckIdentificationNumberInput.val()),userNotFoundModal.modal("hide"),createAccountInputsHolder.show()}))},handleEnrolButtonClick=()=>{enrolButton.click((async()=>{if(!creatingAccount){if(!userCheckIdentificationNumberInput.get(0).reportValidity())return;const params=new URLSearchParams;params.append("field","username"),params.append("values[0]",userCheckIdentificationNumberInput.val());try{let response=await window.fetch(webserviceUrl+"core_user_get_users_by_field&"+params,fetchParams);if(!response.ok)throw new Error("Request failed with status: "+response.status);if(response=await response.json(),!response.length)return void userNotFoundModal.modal("show");enrolContractUser(response[0].id)}catch(error){errorModalContent.html(`<p class="text-center">${error.message}</p>`),errorModal.modal("show"),console.error(error)}}if(!createUserInputs.every((input=>input.get(0).reportValidity())))return;const params=new URLSearchParams;params.append("username",createUserIdentificationNumberInput.val()),params.append("firstname",createUserFirstNameInput.val()),params.append("lastname",createUserLastNameInput.val()),params.append("email",createUserEmailInput.val()),params.append("contractId",enrolContractId),params.append("courseId",enrolCourseId);try{let response=await window.fetch(webserviceUrl+"local_grupomakro_create_student_user&"+params,fetchParams);if(!response.ok)throw new Error("Request failed with status: "+response.status);if(response=await response.json(),-1===response.contractEnrolResult)throw response.message;setTimeout((()=>{window.location.href="https://students-lxp-dev.soluttolabs.com/login"}),5e3)}catch(error){errorModalContent.html(`<p class="text-center">${error}</p>`),errorModal.modal("show"),console.error(error)}}))},enrolContractUser=async userId=>{const params=new URLSearchParams;params.append("userId",userId),params.append("contractId",enrolContractId),params.append("courseIds",enrolCourseId);try{let response=await window.fetch(webserviceUrl+"local_grupomakro_create_contract_user&"+params,fetchParams);if(!response.ok)throw new Error("Request failed with status: "+response.status);if(response=await response.json(),-1===response.contractUserId)throw response.message;if(!response.result)throw response.message;const parsedResponse=JSON.parse(response.result);if(!parsedResponse.success.length)throw parsedResponse.failure[0].message;setTimeout((()=>{window.location.href="https://students-lxp-dev.soluttolabs.com/login"}),5e3)}catch(error){errorModalContent.html(`<p class="text-center">${error}</p>`),errorModal.modal("show")}}}));

//# sourceMappingURL=contract_enrol.min.js.map