{"version":3,"file":"institutional_contracts.min.js","sources":["../src/institutional_contracts.js"],"sourcesContent":["import * as Ajax from 'core/ajax';\nimport $ from 'jquery';\n\nconst createContractButton = $('#create-contract-button')\nconst removeContractButtons = $('.remove-contract')\nconst removeContractConfirmButton = $('#remove-contract-confirm-button')\nconst confirmContractDeletionModal = $('#confirmModalCenter')\n\nconst viewUserDetailsButtons = $('.view-details-button')\nconst userInfoName = $('#user-info-name')\nconst userInfoEmail = $('#user-info-email')\nconst userInfoAvatar = $('#user-info-avatar')\nconst viewUserProfileButton = $('#view-profile-button')\nconst userInfoContractList = $('#user-info-contract-list')\nconst confirmContractUserDeletionModal = $('#confirmContractUserDeletionModal')\nconst confirmContractUserDeletionButton = $('#remove-contract-_user_confirm-button')\n\nconst selectedUserInput = $('#selected-user')\nconst contractSelectInput = $('#contractlist')\nconst coursesSelectInput = $('#courselist')\nconst newContractUserInputs = [selectedUserInput,contractSelectInput,coursesSelectInput]\n\nconst addUserButton = $('#add-user-button')\n\nconst contractIcon = 'https://grupomakro-dev.soluttolabs.com/theme/image.php?theme=soluttolmsadmin&amp;component=local_grupomakro_core&amp;image=t%2Fcontract'\n\nconst errorModal = $('#errorModal');\nconst errorModalContent = $('#error-modal-content');\n\nlet selectedInstitutionId;\nlet selectedContractId;\nlet selectedUser;\nlet selectedInstitutionContractUsers\nlet availableUsers;\nlet selectedUserToBeCreated\nlet institutionContracts\nlet selectedContractUserId\n\nexport const init = (institutionId, institutionContractUsers,users,contractNames) => {\n    selectedInstitutionContractUsers=institutionContractUsers;\n    selectedInstitutionId = institutionId\n    availableUsers=users\n    institutionContracts=contractNames\n    handleCreateContractButtonClick()\n    handleRemoveContractButtonClick()\n    handleRemoveContractConfirmButtonClick()\n    handleRemoveContractUserConfirmButtonClick()\n    handleViewUserDetailsButton()\n    handleViewUserProfileButtonClick();\n    handleDeleteUserContractLinkButtonClick();\n    handleUserCreation()\n};\n\nconst handleUserCreation = () => {\n    addUserButton.click(()=>{\n        selectedUserInput.get(0).setCustomValidity('');\n        // Check the select inputs and the time inputs\n        const valid = newContractUserInputs.every(input => {\n            return input.get(0).reportValidity();\n        });\n        if (!valid) {\n            return;\n        }\n        //\n        \n        if(!selectedUserToBeCreated) {\n            selectedUserInput.get(0).setCustomValidity('Este usuario no existe.');\n            selectedUserInput.get(0).reportValidity();\n            return;\n        }\n        \n        const args = {\n            userId:selectedUserToBeCreated.id,\n            contractId:contractSelectInput.val(),\n            courseIds: coursesSelectInput.val().join(','),\n        };\n        const promise = Ajax.call([{\n            methodname: 'local_grupomakro_create_contract_user',\n            args\n        }, ]);\n        promise[0].done(function(response) {\n            if(response.institutionContractId === -1 ){\n                errorModalContent.html(`<p class=\"text-center\">${response.message}</p>`);\n                errorModal.modal('show');\n                return   \n            }\n            window.location.reload()\n        }).fail(function(error) {\n            console.error(error)\n        });\n    })\n    \n    selectedUserInput.on('input',()=>{\n        $('.contract-inserted-value').remove();\n        selectedUserToBeCreated = availableUsers.find(user=>user.username ===selectedUserInput.val())\n        if(!selectedUserToBeCreated) {\n            contractSelectInput.prop('disabled',true)\n            return\n        }\n        const selectedUserToBeCreatedContractInfo = selectedInstitutionContractUsers[selectedUserToBeCreated.id]\n        const availableContractsForSelectedUser = !selectedUserToBeCreatedContractInfo? institutionContracts: institutionContracts.filter(contract =>{\n             return !selectedUserToBeCreatedContractInfo.contracts.some(userContract=> userContract.id === contract.id)\n        })\n        let contractListOptions = ''\n        availableContractsForSelectedUser.forEach(contractOption=>{\n            contractListOptions+= `<option class=\"contract-inserted-value\" value=\"${contractOption.id}\">${contractOption.contractId}</option>`\n        })\n        contractSelectInput.removeAttr('disabled')\n        contractSelectInput.html(contractSelectInput.html() + contractListOptions)\n    })\n    \n}\n\nconst handleDeleteUserContractLinkButtonClick = ()=> {\n    const deleteUserContractLinkButtons = $('.delete-contract-user-link')\n    deleteUserContractLinkButtons.click(event=>{\n        selectedContractUserId = event.currentTarget.attributes['contract-user-id'].value\n        confirmContractUserDeletionModal.modal('show')\n    })\n    \n    \n}\n\nconst handleRemoveContractUserConfirmButtonClick = () => {\n    confirmContractUserDeletionButton.click(()=>{\n        if(!selectedContractUserId)return\n        const args = {\n            id:selectedContractUserId\n        };\n        const promise = Ajax.call([{\n            methodname: 'local_grupomakro_delete_contract_user',\n            args\n        }, ]);\n        promise[0].done(function(response) {\n            if(response.deletedContractUserId === -1 ){\n                confirmContractUserDeletionModal.modal('hide')\n                errorModalContent.html(`<p class=\"text-center\">${response.message}</p>`);\n                errorModal.modal('show');\n                return   \n            }\n            window.location.reload()\n        }).fail(function(error) {\n            console.error(error)\n        });\n    })\n    \n}\n\nconst handleViewUserProfileButtonClick = () =>{\n    viewUserProfileButton.click(()=>{\n        window.open(selectedUser.profileUrl,'blank')\n    })\n}\n\nconst handleCreateContractButtonClick = () => {\n    createContractButton.click(()=>{\n        window.location.href = `/local/grupomakro_core/pages/createcontractinstitutional.php?id=${selectedInstitutionId}`\n    })\n}\n\nconst handleRemoveContractButtonClick = () => {\n    removeContractButtons.click(event=>{\n        selectedContractId = event.currentTarget.attributes['contract-id'].value\n    })\n}\n\nconst handleRemoveContractConfirmButtonClick = ()=> {\n    removeContractConfirmButton.click(()=>{\n        const args = {\n            id:selectedContractId,\n        };\n        const promise = Ajax.call([{\n            methodname: 'local_grupomakro_delete_institution_contract',\n            args\n        }, ]);\n        promise[0].done(function(response) {\n            if(response.deletedInstitutionContractId === -1 ){\n                confirmContractDeletionModal.modal('hide')\n                errorModalContent.html(`<p class=\"text-center\">${response.message}</p>`);\n                errorModal.modal('show');\n                return   \n            }\n            window.location.reload()\n        }).fail(function(error) {\n            console.error(error)\n        });\n    })\n}\n\nconst handleViewUserDetailsButton = () => {\n    viewUserDetailsButtons.click((event)=> {\n        selectedUser = selectedInstitutionContractUsers[event.currentTarget.attributes['contract-user-id'].value]\n        userInfoName.text(selectedUser.fullname)\n        userInfoName.attr('href',selectedUser.profileUrl)\n        userInfoEmail.text(selectedUser.email)\n        userInfoAvatar.attr('src',selectedUser.avatar)\n        \n        let contractsHtmlString = ''\n        selectedUser.contracts.forEach(contract=>{\n            contractsHtmlString+=`\n            <li class=\"list-group-item d-flex justify-content-between align-items-center\">\n                <div class=\"contracicon d-flex align-items-center\">\n                    <img class=\"icon \" alt=\"\" aria-hidden=\"true\" src=\"${contractIcon}\">\n                    <span class=\"ml-2\">${contract.contractId}</span>\n                </div>\n                <a href=\"#\" class=\"text-secondary delete-contract-user-link\" contract-user-id=\"${contract.contractUserId}\">\n                    <i class=\"fa fa-trash\" style=\"font-size:20px\"></i>\n                </a>\n            </li>`\n        })\n        \n        userInfoContractList.html(contractsHtmlString)\n        handleDeleteUserContractLinkButtonClick()\n    })\n}"],"names":["selectedInstitutionId","selectedContractId","selectedUser","selectedInstitutionContractUsers","availableUsers","selectedUserToBeCreated","institutionContracts","selectedContractUserId","createContractButton","removeContractButtons","removeContractConfirmButton","confirmContractDeletionModal","viewUserDetailsButtons","userInfoName","userInfoEmail","userInfoAvatar","viewUserProfileButton","userInfoContractList","confirmContractUserDeletionModal","confirmContractUserDeletionButton","selectedUserInput","contractSelectInput","coursesSelectInput","newContractUserInputs","addUserButton","errorModal","errorModalContent","institutionId","institutionContractUsers","users","contractNames","handleCreateContractButtonClick","handleRemoveContractButtonClick","handleRemoveContractConfirmButtonClick","handleRemoveContractUserConfirmButtonClick","handleViewUserDetailsButton","handleViewUserProfileButtonClick","handleDeleteUserContractLinkButtonClick","handleUserCreation","click","get","setCustomValidity","every","input","reportValidity","args","userId","id","contractId","val","courseIds","join","Ajax","call","methodname","done","response","institutionContractId","html","message","modal","window","location","reload","fail","error","console","on","remove","find","user","username","selectedUserToBeCreatedContractInfo","availableContractsForSelectedUser","filter","contract","contracts","some","userContract","contractListOptions","forEach","contractOption","removeAttr","prop","event","currentTarget","attributes","value","deletedContractUserId","open","profileUrl","href","deletedInstitutionContractId","text","fullname","attr","email","avatar","contractsHtmlString","contractUserId"],"mappings":"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"}