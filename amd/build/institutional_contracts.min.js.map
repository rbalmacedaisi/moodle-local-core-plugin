{"version":3,"file":"institutional_contracts.min.js","sources":["../src/institutional_contracts.js"],"sourcesContent":["import * as Ajax from 'core/ajax';\nimport $ from 'jquery';\n\nconst createContractButton = $('#create-contract-button')\nconst removeContractButtons = $('.remove-contract')\nconst removeContractConfirmButton = $('#remove-contract-confirm-button')\nconst confirmContractDeletionModal = $('#confirmModalCenter')\n\nconst viewUserDetailsButtons = $('.view-details-button')\nconst userInfoName = $('#user-info-name')\nconst userInfoEmail = $('#user-info-email')\nconst userInfoAvatar = $('#user-info-avatar')\nconst viewUserProfileButton = $('#view-profile-button')\nconst userInfoContractList = $('#user-info-contract-list')\nconst confirmContractUserDeletionModal = $('#confirmContractUserDeletionModal')\nconst confirmContractUserDeletionButton = $('#remove-contract-_user_confirm-button')\n\nconst selectedUserInput = $('#selected-user')\nconst contractSelectInput = $('#contractlist')\nconst coursesSelectInput = $('#courselist')\nconst newContractUserInputs = [selectedUserInput,contractSelectInput,coursesSelectInput]\nconst addUserButton = $('#add-user-button')\n\nconst generateEnrolLinkModal = $('#generateEnrolLinkModal');\nconst enrolLinkContractListSelect = $('#enrolLinkContractList');\nconst enrolLinkCourseListSelect = $('#enrolLinkCourseList');\nconst enrolLinkInputs = [enrolLinkContractListSelect,enrolLinkCourseListSelect];\nconst enrolLinkGenerateButton = $('#generate-enrol-button');\n\nconst genetaredLinkInfoModal = $('#generatedLinkInfoModal')\nconst enrolLinkExpirationDateContainer = $('#enrolLinkExpirationDate')\nconst enrolLinkUrlContainer = $('#enrolLinkUrl')\nconst enrolUrlClipboardCopyButton = $('#enrolUrlClipboardCopy')\n\nconst contractIcon = 'https://grupomakro-dev.soluttolabs.com/theme/image.php?theme=soluttolmsadmin&amp;component=local_grupomakro_core&amp;image=t%2Fcontract'\n\nconst errorModal = $('#errorModal');\nconst errorModalContent = $('#error-modal-content');\n\nlet selectedInstitutionId;\nlet selectedContractId;\nlet selectedUser;\nlet selectedInstitutionContractUsers\nlet availableUsers;\nlet selectedUserToBeCreated\nlet institutionContracts\nlet selectedContractUserId\nlet generatedEnrolLinkUrl\n\nexport const init = (institutionId, institutionContractUsers,users,contractNames) => {\n    selectedInstitutionContractUsers=institutionContractUsers;\n    selectedInstitutionId = institutionId\n    availableUsers=users\n    institutionContracts=contractNames\n    handleCreateContractButtonClick()\n    handleRemoveContractButtonClick()\n    handleRemoveContractConfirmButtonClick()\n    handleRemoveContractUserConfirmButtonClick()\n    handleViewUserDetailsButton()\n    handleViewUserProfileButtonClick();\n    handleDeleteUserContractLinkButtonClick();\n    handleUserCreation();\n    handleEnrolLinkGenerateButtonClick()\n    handleEnrolUrlClipboardCopyButton()\n};\n\nconst handleEnrolUrlClipboardCopyButton = () => {\n    enrolUrlClipboardCopyButton.click(()=>{\n        window.navigator.clipboard.writeText(generatedEnrolLinkUrl)\n        window.alert('Se ha copiado la url')\n    })\n}\n\nconst handleEnrolLinkGenerateButtonClick = () => {\n    enrolLinkGenerateButton.click(()=>{\n        // Check the select inputs and the time inputs\n        const valid = enrolLinkInputs.every(input => {\n            return input.get(0).reportValidity();\n        });\n        if (!valid) {\n            return;\n        }\n        //\n        const args = {\n            contractId:enrolLinkContractListSelect.val(),\n            courseId:enrolLinkCourseListSelect.val()\n        };\n        const promise = Ajax.call([{\n            methodname: 'local_grupomakro_generate_contract_enrol_link',\n            args\n        }, ]);\n        promise[0].done(function(response) {\n            if(response.contractEnrolLink === '-1' ){\n                errorModalContent.html(`<p class=\"text-center\">${response.message}</p>`);\n                errorModal.modal('show');\n                return   \n            }\n            generateEnrolLinkModal.modal('hide');\n            enrolLinkExpirationDateContainer.text(response.expirationDate);\n            enrolLinkUrlContainer.text(response.contractEnrolLink);\n            generatedEnrolLinkUrl = response.contractEnrolLink\n            genetaredLinkInfoModal.modal('show');\n        }).fail(function(error) {\n            console.error(error)\n        });\n        \n    })\n}\n\nconst handleUserCreation = () => {\n    addUserButton.click(()=>{\n        selectedUserInput.get(0).setCustomValidity('');\n        // Check the select inputs and the time inputs\n        const valid = newContractUserInputs.every(input => {\n            return input.get(0).reportValidity();\n        });\n        if (!valid) {\n            return;\n        }\n        //\n        \n        if(!selectedUserToBeCreated) {\n            selectedUserInput.get(0).setCustomValidity('Este usuario no existe.');\n            selectedUserInput.get(0).reportValidity();\n            return;\n        }\n        \n        const args = {\n            userId:selectedUserToBeCreated.id,\n            contractId:contractSelectInput.val(),\n            courseIds: coursesSelectInput.val().join(','),\n        };\n        const promise = Ajax.call([{\n            methodname: 'local_grupomakro_create_contract_user',\n            args\n        }, ]);\n        promise[0].done(function(response) {\n            if(response.institutionContractId === -1 ){\n                errorModalContent.html(`<p class=\"text-center\">${response.message}</p>`);\n                errorModal.modal('show');\n                return   \n            }\n            window.location.reload()\n        }).fail(function(error) {\n            console.error(error)\n        });\n    })\n    \n    selectedUserInput.on('input',()=>{\n        selectedUserToBeCreated = availableUsers.find(user=>user.username ===selectedUserInput.val())\n        if(!selectedUserToBeCreated) {\n            contractSelectInput.prop('disabled',true)\n            return\n        }\n        contractSelectInput.removeAttr('disabled')\n    })\n    \n}\n\nconst handleDeleteUserContractLinkButtonClick = ()=> {\n    const deleteUserContractLinkButtons = $('.delete-contract-user-link')\n    deleteUserContractLinkButtons.click(event=>{\n        selectedContractUserId = event.currentTarget.attributes['contract-user-id'].value\n        confirmContractUserDeletionModal.modal('show')\n    })\n    \n    \n}\n\nconst handleRemoveContractUserConfirmButtonClick = () => {\n    confirmContractUserDeletionButton.click(()=>{\n        if(!selectedContractUserId)return\n        const args = {\n            id:selectedContractUserId\n        };\n        const promise = Ajax.call([{\n            methodname: 'local_grupomakro_delete_contract_user',\n            args\n        }, ]);\n        promise[0].done(function(response) {\n            if(response.deletedContractUserId === -1 ){\n                confirmContractUserDeletionModal.modal('hide')\n                errorModalContent.html(`<p class=\"text-center\">${response.message}</p>`);\n                errorModal.modal('show');\n                return   \n            }\n            window.location.reload()\n        }).fail(function(error) {\n            console.error(error)\n        });\n    })\n    \n}\n\nconst handleViewUserProfileButtonClick = () =>{\n    viewUserProfileButton.click(()=>{\n        window.open(selectedUser.profileUrl,'blank')\n    })\n}\n\nconst handleCreateContractButtonClick = () => {\n    createContractButton.click(()=>{\n        window.location.href = `/local/grupomakro_core/pages/createcontractinstitutional.php?id=${selectedInstitutionId}`\n    })\n}\n\nconst handleRemoveContractButtonClick = () => {\n    removeContractButtons.click(event=>{\n        selectedContractId = event.currentTarget.attributes['contract-id'].value\n    })\n}\n\nconst handleRemoveContractConfirmButtonClick = ()=> {\n    removeContractConfirmButton.click(()=>{\n        const args = {\n            id:selectedContractId,\n        };\n        const promise = Ajax.call([{\n            methodname: 'local_grupomakro_delete_institution_contract',\n            args\n        }, ]);\n        promise[0].done(function(response) {\n            if(response.deletedInstitutionContractId === -1 ){\n                confirmContractDeletionModal.modal('hide')\n                errorModalContent.html(`<p class=\"text-center\">${response.message}</p>`);\n                errorModal.modal('show');\n                return   \n            }\n            window.location.reload()\n        }).fail(function(error) {\n            console.error(error)\n        });\n    })\n}\n\nconst handleViewUserDetailsButton = () => {\n    viewUserDetailsButtons.click((event)=> {\n        selectedUser = selectedInstitutionContractUsers[event.currentTarget.attributes['contract-user-id'].value]\n        userInfoName.text(selectedUser.fullname)\n        userInfoName.attr('href',selectedUser.profileUrl)\n        userInfoEmail.text(selectedUser.email)\n        userInfoAvatar.attr('src',selectedUser.avatar)\n        \n        let contractsHtmlString = ''\n        selectedUser.contracts.forEach(contract=>{\n            contractsHtmlString+=`\n            <li class=\"list-group-item d-flex justify-content-between align-items-center\">\n                <div class=\"contracicon d-flex align-items-center\">\n                    <img class=\"icon \" alt=\"\" aria-hidden=\"true\" src=\"${contractIcon}\">\n                    <span class=\"ml-2\">${contract.contractId}</span>\n                    <span class=\"ml-2\">${contract.courseName}</span>\n                </div>\n                <a href=\"#\" class=\"text-secondary delete-contract-user-link\" contract-user-id=\"${contract.id}\">\n                    <i class=\"fa fa-trash\" style=\"font-size:20px\"></i>\n                </a>\n            </li>`\n        })\n        \n        userInfoContractList.html(contractsHtmlString)\n        handleDeleteUserContractLinkButtonClick()\n    })\n}"],"names":["selectedInstitutionId","selectedContractId","selectedUser","selectedInstitutionContractUsers","availableUsers","selectedUserToBeCreated","selectedContractUserId","generatedEnrolLinkUrl","createContractButton","removeContractButtons","removeContractConfirmButton","confirmContractDeletionModal","viewUserDetailsButtons","userInfoName","userInfoEmail","userInfoAvatar","viewUserProfileButton","userInfoContractList","confirmContractUserDeletionModal","confirmContractUserDeletionButton","selectedUserInput","contractSelectInput","coursesSelectInput","newContractUserInputs","addUserButton","generateEnrolLinkModal","enrolLinkContractListSelect","enrolLinkCourseListSelect","enrolLinkInputs","enrolLinkGenerateButton","genetaredLinkInfoModal","enrolLinkExpirationDateContainer","enrolLinkUrlContainer","enrolUrlClipboardCopyButton","errorModal","errorModalContent","institutionId","institutionContractUsers","users","contractNames","handleCreateContractButtonClick","handleRemoveContractButtonClick","handleRemoveContractConfirmButtonClick","handleRemoveContractUserConfirmButtonClick","handleViewUserDetailsButton","handleViewUserProfileButtonClick","handleDeleteUserContractLinkButtonClick","handleUserCreation","handleEnrolLinkGenerateButtonClick","handleEnrolUrlClipboardCopyButton","click","window","navigator","clipboard","writeText","alert","every","input","get","reportValidity","args","contractId","val","courseId","Ajax","call","methodname","done","response","contractEnrolLink","html","message","modal","text","expirationDate","fail","error","console","setCustomValidity","userId","id","courseIds","join","institutionContractId","location","reload","on","find","user","username","removeAttr","prop","event","currentTarget","attributes","value","deletedContractUserId","open","profileUrl","href","deletedInstitutionContractId","fullname","attr","email","avatar","contractsHtmlString","contracts","forEach","contract","courseName"],"mappings":"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"}