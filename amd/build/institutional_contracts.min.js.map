{"version":3,"file":"institutional_contracts.min.js","sources":["../src/institutional_contracts.js"],"sourcesContent":["import * as Ajax from 'core/ajax';\nimport $ from 'jquery';\n\nconst createContractButton = $('#create-contract-button')\nconst removeContractButtons = $('.remove-contract')\nconst removeContractConfirmButton = $('#remove-contract-confirm-button')\nconst confirmContractDeletionModal = $('#confirmModalCenter')\n\nconst viewUserDetailsButtons = $('.view-details-button')\nconst userInfoName = $('#user-info-name')\nconst userInfoEmail = $('#user-info-email')\nconst userInfoAvatar = $('#user-info-avatar')\nconst viewUserProfileButton = $('#view-profile-button')\nconst userInfoContractList = $('#user-info-contract-list')\nconst confirmContractUserDeletionModal = $('#confirmContractUserDeletionModal')\nconst confirmContractUserDeletionButton = $('#remove-contract-_user_confirm-button')\n\nconst selectedUserInput = $('#selected-user')\nconst contractSelectInput = $('#contractlist')\nconst coursesSelectInput = $('#courselist')\nconst newContractUserInputs = [selectedUserInput,contractSelectInput,coursesSelectInput]\nconst addUserButton = $('#add-user-button')\n\nconst generateEnrolLinkModal = $('#generateEnrolLinkModal');\nconst enrolLinkContractListSelect = $('#enrolLinkContractList');\nconst enrolLinkCourseListSelect = $('#enrolLinkCourseList');\nconst enrolLinkInputs = [enrolLinkContractListSelect,enrolLinkCourseListSelect];\nconst enrolLinkGenerateButton = $('#generate-enrol-button');\n\nconst genetaredLinkInfoModal = $('#generatedLinkInfoModal')\nconst enrolLinkExpirationDateContainer = $('#enrolLinkExpirationDate')\nconst enrolLinkUrlContainer = $('#enrolLinkUrl')\nconst enrolUrlClipboardCopyButton = $('#enrolUrlClipboardCopy')\n\nconst bulkUserContractInput = $('#upload_massive_inst_users');\nconst bulkConfirmModal = $('#bulkConfirmModal');\nconst bulkConfirmModalButton = $('#bulkConfirmModalButton');\nconst bulkCancelModalButton = $('#bulkCancelModalButton');\n\nconst contractIcon = 'https://grupomakro-dev.soluttolabs.com/theme/image.php?theme=soluttolmsadmin&amp;component=local_grupomakro_core&amp;image=t%2Fcontract'\n\nconst errorModal = $('#errorModal');\nconst errorModalContent = $('#error-modal-content');\n\n\n\nlet selectedInstitutionId;\nlet selectedContractId;\nlet selectedUser;\nlet selectedInstitutionContractUsers\nlet availableUsers;\nlet selectedUserToBeCreated\nlet institutionContracts\nlet selectedContractUserId\nlet generatedEnrolLinkUrl\nlet bulkFile;\n\nexport const init = (institutionId, institutionContractUsers,users,contractNames) => {\n    selectedInstitutionContractUsers=institutionContractUsers;\n    selectedInstitutionId = institutionId\n    availableUsers=users\n    institutionContracts=contractNames\n    handleCreateContractButtonClick()\n    handleRemoveContractButtonClick()\n    handleRemoveContractConfirmButtonClick()\n    handleRemoveContractUserConfirmButtonClick()\n    handleViewUserDetailsButton()\n    handleViewUserProfileButtonClick();\n    handleDeleteUserContractLinkButtonClick();\n    handleUserCreation();\n    handleEnrolLinkGenerateButtonClick()\n    handleEnrolUrlClipboardCopyButton()\n    handleBulkContractUserInput()\n};\n\nconst handleBulkContractUserInput = () => {\n    bulkUserContractInput.on('change',(event)=>{\n        bulkFile = event.target.files[0];\n        bulkConfirmModal.modal('show')\n        console.log(bulkFile);\n    })\n    \n    bulkConfirmModalButton.click(async()=>{\n        const formData = new FormData();\n        formData.append('file', bulkFile);\n        formData.append('token', '33513bec0b3469194c7756c29bf9fb33');\n        const fetchParams = {\n            method: 'POST',\n            body:formData\n        }\n        try{\n            let bulkCSVUploadResponse = await window.fetch('https://grupomakro-dev.soluttolabs.com/webservice/upload.php', fetchParams)\n            if (!bulkCSVUploadResponse.ok) {\n                throw new Error('Request failed with status: ' + bulkCSVUploadResponse.status);\n            }\n            bulkCSVUploadResponse = await bulkCSVUploadResponse.json();\n            bulkCSVUploadResponse = bulkCSVUploadResponse[0]\n            const args = {\n                contextId:bulkCSVUploadResponse.contextid,\n                itemId:bulkCSVUploadResponse.itemid,\n                filename:bulkCSVUploadResponse.filename\n            }\n            const bulkEnrolResponse =await Ajax.call([{\n                methodname: 'local_grupomakro_bulk_create_contract_user',\n                args\n            }])[0];\n            if(!bulkEnrolResponse.result)throw bulkEnrolResponse.message\n            window.location.reload()\n            \n        }catch (error){\n            errorModalContent.html(`<p class=\"text-center\">${error}</p>`);\n            errorModal.modal('show');\n            console.error(error);\n        }finally{\n            return;\n        }\n    })\n    \n    bulkCancelModalButton.click(()=>{\n        bulkConfirmModal.modal('hide')\n        bulkFile=undefined;\n    })\n}\n\nconst handleEnrolUrlClipboardCopyButton = () => {\n    enrolUrlClipboardCopyButton.click(()=>{\n        window.navigator.clipboard.writeText(generatedEnrolLinkUrl)\n        window.alert('Se ha copiado la url')\n    })\n}\n\nconst handleEnrolLinkGenerateButtonClick = () => {\n    enrolLinkGenerateButton.click(()=>{\n        // Check the select inputs and the time inputs\n        const valid = enrolLinkInputs.every(input => {\n            return input.get(0).reportValidity();\n        });\n        if (!valid) {\n            return;\n        }\n        //\n        const args = {\n            contractId:enrolLinkContractListSelect.val(),\n            courseId:enrolLinkCourseListSelect.val()\n        };\n        const promise = Ajax.call([{\n            methodname: 'local_grupomakro_generate_contract_enrol_link',\n            args\n        }, ]);\n        promise[0].done(function(response) {\n            if(response.contractEnrolLink === '-1' ){\n                errorModalContent.html(`<p class=\"text-center\">${response.message}</p>`);\n                errorModal.modal('show');\n                return   \n            }\n            generateEnrolLinkModal.modal('hide');\n            enrolLinkExpirationDateContainer.text(response.expirationDate);\n            enrolLinkUrlContainer.text(response.contractEnrolLink);\n            generatedEnrolLinkUrl = response.contractEnrolLink\n            genetaredLinkInfoModal.modal('show');\n        }).fail(function(error) {\n            console.error(error)\n        });\n        \n    })\n}\n\nconst handleUserCreation = () => {\n    addUserButton.click(()=>{\n        selectedUserInput.get(0).setCustomValidity('');\n        // Check the select inputs and the time inputs\n        const valid = newContractUserInputs.every(input => {\n            return input.get(0).reportValidity();\n        });\n        if (!valid) {\n            return;\n        }\n        //\n        \n        if(!selectedUserToBeCreated) {\n            selectedUserInput.get(0).setCustomValidity('Este usuario no existe.');\n            selectedUserInput.get(0).reportValidity();\n            return;\n        }\n        \n        const args = {\n            userId:selectedUserToBeCreated.id,\n            contractId:contractSelectInput.val(),\n            courseIds: coursesSelectInput.val().join(',') \n        };\n        const promise = Ajax.call([{\n            methodname: 'local_grupomakro_create_contract_user',\n            args\n        }, ]);\n        promise[0].done(function(response) {\n            if(!response.result){\n                errorModalContent.html(`<p class=\"text-center\">${response.message}</p>`);\n                errorModal.modal('show');\n            }\n            const parsedResponse = JSON.parse(response.result)\n            console.log(parsedResponse);\n            if(!parsedResponse.success.length ){\n                \n                errorModalContent.html(`<p class=\"text-center\">${parsedResponse.failure[0].message}</p>`);\n                errorModal.modal('show');\n                return   \n            }\n            window.location.reload()\n        }).fail(function(error) {\n            console.error(error)\n        });\n    })\n    \n    selectedUserInput.on('input',()=>{\n        selectedUserToBeCreated = availableUsers.find(user=>user.username ===selectedUserInput.val())\n        if(!selectedUserToBeCreated) {\n            contractSelectInput.prop('disabled',true)\n            return\n        }\n        contractSelectInput.removeAttr('disabled')\n    })\n    \n}\n\nconst handleDeleteUserContractLinkButtonClick = ()=> {\n    const deleteUserContractLinkButtons = $('.delete-contract-user-link')\n    deleteUserContractLinkButtons.click(event=>{\n        selectedContractUserId = event.currentTarget.attributes['contract-user-id'].value\n        confirmContractUserDeletionModal.modal('show')\n    })\n    \n    \n}\n\nconst handleRemoveContractUserConfirmButtonClick = () => {\n    confirmContractUserDeletionButton.click(()=>{\n        if(!selectedContractUserId)return\n        const args = {\n            id:selectedContractUserId\n        };\n        const promise = Ajax.call([{\n            methodname: 'local_grupomakro_delete_contract_user',\n            args\n        }, ]);\n        promise[0].done(function(response) {\n            if(response.deletedContractUserId === -1 ){\n                confirmContractUserDeletionModal.modal('hide')\n                errorModalContent.html(`<p class=\"text-center\">${response.message}</p>`);\n                errorModal.modal('show');\n                return   \n            }\n            window.location.reload()\n        }).fail(function(error) {\n            console.error(error)\n        });\n    })\n    \n}\n\nconst handleViewUserProfileButtonClick = () =>{\n    viewUserProfileButton.click(()=>{\n        window.open(selectedUser.profileUrl,'blank')\n    })\n}\n\nconst handleCreateContractButtonClick = () => {\n    createContractButton.click(()=>{\n        window.location.href = `/local/grupomakro_core/pages/createcontractinstitutional.php?id=${selectedInstitutionId}`\n    })\n}\n\nconst handleRemoveContractButtonClick = () => {\n    removeContractButtons.click(event=>{\n        selectedContractId = event.currentTarget.attributes['contract-id'].value\n    })\n}\n\nconst handleRemoveContractConfirmButtonClick = ()=> {\n    removeContractConfirmButton.click(()=>{\n        const args = {\n            id:selectedContractId,\n        };\n        const promise = Ajax.call([{\n            methodname: 'local_grupomakro_delete_institution_contract',\n            args\n        }, ]);\n        promise[0].done(function(response) {\n            if(response.deletedInstitutionContractId === -1 ){\n                confirmContractDeletionModal.modal('hide')\n                errorModalContent.html(`<p class=\"text-center\">${response.message}</p>`);\n                errorModal.modal('show');\n                return   \n            }\n            window.location.reload()\n        }).fail(function(error) {\n            console.error(error)\n        });\n    })\n}\n\nconst handleViewUserDetailsButton = () => {\n    viewUserDetailsButtons.click((event)=> {\n        selectedUser = selectedInstitutionContractUsers[event.currentTarget.attributes['contract-user-id'].value]\n        userInfoName.text(selectedUser.fullname)\n        userInfoName.attr('href',selectedUser.profileUrl)\n        userInfoEmail.text(selectedUser.email)\n        userInfoAvatar.attr('src',selectedUser.avatar)\n        \n        let contractsHtmlString = ''\n        selectedUser.contracts.forEach(contract=>{\n            contractsHtmlString+=`\n            <li class=\"list-group-item d-flex justify-content-between align-items-center\">\n                <div class=\"contracicon d-flex align-items-center\">\n                    <img class=\"icon \" alt=\"\" aria-hidden=\"true\" src=\"${contractIcon}\">\n                    <span class=\"ml-2\">${contract.contractId}</span>\n                    <span class=\"ml-2\">${contract.courseName}</span>\n                </div>\n                <a href=\"#\" class=\"text-secondary delete-contract-user-link\" contract-user-id=\"${contract.id}\">\n                    <i class=\"fa fa-trash\" style=\"font-size:20px\"></i>\n                </a>\n            </li>`\n        })\n        \n        userInfoContractList.html(contractsHtmlString)\n        handleDeleteUserContractLinkButtonClick()\n    })\n}"],"names":["selectedInstitutionId","selectedContractId","selectedUser","selectedInstitutionContractUsers","availableUsers","selectedUserToBeCreated","selectedContractUserId","generatedEnrolLinkUrl","bulkFile","createContractButton","removeContractButtons","removeContractConfirmButton","confirmContractDeletionModal","viewUserDetailsButtons","userInfoName","userInfoEmail","userInfoAvatar","viewUserProfileButton","userInfoContractList","confirmContractUserDeletionModal","confirmContractUserDeletionButton","selectedUserInput","contractSelectInput","coursesSelectInput","newContractUserInputs","addUserButton","generateEnrolLinkModal","enrolLinkContractListSelect","enrolLinkCourseListSelect","enrolLinkInputs","enrolLinkGenerateButton","genetaredLinkInfoModal","enrolLinkExpirationDateContainer","enrolLinkUrlContainer","enrolUrlClipboardCopyButton","bulkUserContractInput","bulkConfirmModal","bulkConfirmModalButton","bulkCancelModalButton","errorModal","errorModalContent","institutionId","institutionContractUsers","users","contractNames","handleCreateContractButtonClick","handleRemoveContractButtonClick","handleRemoveContractConfirmButtonClick","handleRemoveContractUserConfirmButtonClick","handleViewUserDetailsButton","handleViewUserProfileButtonClick","handleDeleteUserContractLinkButtonClick","handleUserCreation","handleEnrolLinkGenerateButtonClick","handleEnrolUrlClipboardCopyButton","handleBulkContractUserInput","on","event","target","files","modal","console","log","click","formData","FormData","append","fetchParams","method","body","window","fetch","bulkCSVUploadResponse","ok","Error","status","json","args","contextId","contextid","itemId","itemid","filename","Ajax","call","methodname","bulkEnrolResponse","result","message","location","reload","html","error","undefined","navigator","clipboard","writeText","alert","every","input","get","reportValidity","contractId","val","courseId","done","response","contractEnrolLink","text","expirationDate","fail","setCustomValidity","userId","id","courseIds","join","parsedResponse","JSON","parse","success","length","failure","find","user","username","removeAttr","prop","currentTarget","attributes","value","deletedContractUserId","open","profileUrl","href","deletedInstitutionContractId","fullname","attr","email","avatar","contractsHtmlString","contracts","forEach","contract","courseName"],"mappings":"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"}