define("local_grupomakro_core/institutional_contracts",["exports","core/ajax","jquery"],(function(_exports,Ajax,_jquery){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,Ajax=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Ajax);const createContractButton=(0,(_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj}).default)("#create-contract-button"),removeContractButtons=(0,_jquery.default)(".remove-contract"),removeContractConfirmButton=(0,_jquery.default)("#remove-contract-confirm-button"),confirmContractDeletionModal=(0,_jquery.default)("#confirmContractDeletionModal"),viewUserDetailsButtons=(0,_jquery.default)(".view-details-button"),userInfoName=(0,_jquery.default)("#user-info-name"),userInfoEmail=(0,_jquery.default)("#user-info-email"),userInfoAvatar=(0,_jquery.default)("#user-info-avatar"),viewUserProfileButton=(0,_jquery.default)("#view-profile-button"),userInfoContractList=(0,_jquery.default)("#user-info-contract-list"),confirmContractUserDeletionModal=(0,_jquery.default)("#confirmContractUserDeletionModal"),confirmContractUserDeletionButton=(0,_jquery.default)("#remove-contract-user-confirm-button"),selectedUserInput=(0,_jquery.default)("#selected-user"),contractSelectInput=(0,_jquery.default)("#contractlist"),coursesSelectInput=(0,_jquery.default)("#courselist"),newContractUserInputs=[selectedUserInput,contractSelectInput,coursesSelectInput],addUserButton=(0,_jquery.default)("#add-user-button"),generateEnrolLinkModal=(0,_jquery.default)("#generateEnrolLinkModal"),enrolLinkContractListSelect=(0,_jquery.default)("#enrolLinkContractList"),enrolLinkCourseListSelect=(0,_jquery.default)("#enrolLinkCourseList"),enrolLinkInputs=[enrolLinkContractListSelect,enrolLinkCourseListSelect],enrolLinkGenerateButton=(0,_jquery.default)("#generate-enrol-button"),genetaredLinkInfoModal=(0,_jquery.default)("#generatedLinkInfoModal"),enrolLinkExpirationDateContainer=(0,_jquery.default)("#enrolLinkExpirationDate"),enrolLinkUrlContainer=(0,_jquery.default)("#enrolLinkUrl"),enrolUrlClipboardCopyButton=(0,_jquery.default)("#enrolUrlClipboardCopy"),bulkUserContractInput=(0,_jquery.default)("#upload_massive_inst_users"),bulkConfirmModal=(0,_jquery.default)("#bulkConfirmModal"),bulkConfirmModalButton=(0,_jquery.default)("#bulkConfirmModalButton"),bulkCancelModalButton=(0,_jquery.default)("#bulkCancelModalButton"),bulkReportModal=(0,_jquery.default)("#bulkReportModal"),bulkResultTableBody=(0,_jquery.default)("#bulkResultTableBody"),bulkReportContinueButton=(0,_jquery.default)("#bulk-report-continue"),contractSearch=(0,_jquery.default)("#contract-search"),contractUserSearch=(0,_jquery.default)("#contract-user-search"),contractApplyFilterButton=(0,_jquery.default)("#contract-apply-filter-button"),userContractApplyFilterButton=(0,_jquery.default)("#user-contract-apply-filter-button"),contractRemoveFilterButton=(0,_jquery.default)("#contract-remove-filter-button"),userContractRemoveFilterButton=(0,_jquery.default)("#user-contract-remove-filter-button"),contractIcon=`${window.location.href}/theme/image.php?\n                    theme=soluttolmsadmin&\n                    amp;component=local_grupomakro_core&\n                    amp;image=t%2Fcontract`,errorModal=(0,_jquery.default)("#errorModal"),errorModalContent=(0,_jquery.default)("#error-modal-content");let selectedInstitutionId,selectedContractId,selectedUser,selectedInstitutionContractUsers,availableUsers,selectedUserToBeCreated,selectedContractUserId,generatedEnrolLinkUrl,bulkFile,token;_exports.init=(institutionId,institutionContractUsers,users,userToken)=>{token=userToken,selectedInstitutionContractUsers=institutionContractUsers,selectedInstitutionId=institutionId,availableUsers=users,handleCreateContractButtonClick(),handleRemoveContractButtonClick(),handleRemoveContractConfirmButtonClick(),handleRemoveContractUserConfirmButtonClick(),handleViewUserDetailsButton(),handleViewUserProfileButtonClick(),handleDeleteUserContractLinkButtonClick(),handleUserCreation(),handleEnrolLinkGenerateButtonClick(),handleEnrolUrlClipboardCopyButton(),handleBulkContractUserInput(),handleAddFilters(),handleRemoveFilters()};const handleRemoveFilters=()=>{contractRemoveFilterButton.click((()=>{const contractUserFilter=new URLSearchParams(window.location.search).get("contractUserFilter");window.location.href=`/local/grupomakro_core/pages/institutionalcontracts.php?\n        id=${selectedInstitutionId}\n        ${contractUserFilter?`&contractUserFilter=${contractUserFilter}`:""}`})),userContractRemoveFilterButton.click((()=>{const contractFilter=new URLSearchParams(window.location.search).get("contractFilter");window.location.href=`/local/grupomakro_core/pages/institutionalcontracts.php?\n        id=${selectedInstitutionId}\n        ${contractFilter?`&contractFilter=${contractFilter}`:""}#users`}))},handleAddFilters=()=>{contractApplyFilterButton.click((()=>{const contractUserFilter=new URLSearchParams(window.location.search).get("contractUserFilter");window.location.href=`/local/grupomakro_core/pages/institutionalcontracts.php?\n        id=${selectedInstitutionId}&contractFilter=${contractSearch.val()}\n        ${contractUserFilter?`&contractUserFilter=${contractUserFilter}`:""}`})),userContractApplyFilterButton.click((()=>{const contractFilter=new URLSearchParams(window.location.search).get("contractFilter");window.location.href=`/local/grupomakro_core/pages/institutionalcontracts.php?\n        id=${selectedInstitutionId}&contractUserFilter=${contractUserSearch.val()}\n        ${contractFilter?`&contractFilter=${contractFilter}`:""}#users`}))},handleBulkContractUserInput=()=>{bulkReportContinueButton.click((()=>{window.location.reload()})),bulkUserContractInput.on("change",(event=>{bulkFile=event.target.files[0],bulkConfirmModal.modal("show")})),bulkConfirmModalButton.click((async()=>{const formData=new FormData;formData.append("file",bulkFile),formData.append("token",token);const fetchParams={method:"POST",body:formData};try{let bulkCSVUploadResponse=await window.fetch(`${window.location.href}/webservice/upload.php`,fetchParams);if(!bulkCSVUploadResponse.ok)throw new Error("Request failed with status: "+bulkCSVUploadResponse.status);bulkCSVUploadResponse=await bulkCSVUploadResponse.json(),bulkCSVUploadResponse=bulkCSVUploadResponse[0];const args={contextId:bulkCSVUploadResponse.contextid,itemId:bulkCSVUploadResponse.itemid,filename:bulkCSVUploadResponse.filename},bulkEnrolResponse=await Ajax.call([{methodname:"local_grupomakro_bulk_create_contract_user",args:args}])[0];if(!bulkEnrolResponse.result)throw bulkEnrolResponse.message;const bulkResults=JSON.parse(bulkEnrolResponse.result);bulkConfirmModal.modal("hide"),bulkReportModal.modal("show");let bulkResultTableRowsHtmlString="";bulkResults.errors.forEach((record=>{bulkResultTableRowsHtmlString+=`<tr class="inserted-error">\n                      <th scope="row">${record.index}</th>\n                      <td>${record.error}</td>\n                    </tr>`})),bulkResultTableBody.html(bulkResultTableRowsHtmlString)}catch(error){errorModalContent.html(`<p class="text-center">${error}</p>`),errorModal.modal("show")}})),bulkCancelModalButton.click((()=>{bulkConfirmModal.modal("hide"),bulkFile=void 0}))},handleEnrolUrlClipboardCopyButton=()=>{enrolUrlClipboardCopyButton.click((()=>{window.navigator.clipboard.writeText(generatedEnrolLinkUrl),window.alert("Se ha copiado la url")}))},handleEnrolLinkGenerateButtonClick=()=>{enrolLinkGenerateButton.click((()=>{if(!enrolLinkInputs.every((input=>input.get(0).reportValidity())))return;const args={contractId:enrolLinkContractListSelect.val(),courseId:enrolLinkCourseListSelect.val()};Ajax.call([{methodname:"local_grupomakro_generate_contract_enrol_link",args:args}])[0].done((function(response){if("-1"===response.contractEnrolLink)return errorModalContent.html(`<p class="text-center">${response.message}</p>`),void errorModal.modal("show");generateEnrolLinkModal.modal("hide"),enrolLinkExpirationDateContainer.text(response.expirationDate),enrolLinkUrlContainer.text(response.contractEnrolLink),generatedEnrolLinkUrl=response.contractEnrolLink,genetaredLinkInfoModal.modal("show")})).fail((function(error){window.alert(error)}))}))},handleUserCreation=()=>{addUserButton.click((()=>{selectedUserInput.get(0).setCustomValidity("");if(!newContractUserInputs.every((input=>input.get(0).reportValidity())))return;if(!selectedUserToBeCreated)return selectedUserInput.get(0).setCustomValidity("Este usuario no existe."),void selectedUserInput.get(0).reportValidity();const args={userId:selectedUserToBeCreated.id,contractId:contractSelectInput.val(),courseIds:coursesSelectInput.val().join(",")};Ajax.call([{methodname:"local_grupomakro_create_contract_user",args:args}])[0].done((function(response){response.result||(errorModalContent.html(`<p class="text-center">${response.message}</p>`),errorModal.modal("show"));const parsedResponse=JSON.parse(response.result);if(!parsedResponse.success.length)return errorModalContent.html(`<p class="text-center">${parsedResponse.failure[0].message}</p>`),void errorModal.modal("show");window.location.reload()})).fail((function(error){window.alert(error)}))})),selectedUserInput.on("input",(()=>{selectedUserToBeCreated=availableUsers.find((user=>user.username===selectedUserInput.val())),selectedUserToBeCreated?contractSelectInput.removeAttr("disabled"):contractSelectInput.prop("disabled",!0)}))},handleDeleteUserContractLinkButtonClick=()=>{(0,_jquery.default)(".delete-contract-user-link").click((event=>{selectedContractUserId=event.currentTarget.attributes["contract-user-id"].value,confirmContractUserDeletionModal.modal("show")}))},handleRemoveContractUserConfirmButtonClick=()=>{confirmContractUserDeletionButton.click((()=>{if(!selectedContractUserId)return;const args={id:selectedContractUserId};Ajax.call([{methodname:"local_grupomakro_delete_contract_user",args:args}])[0].done((function(response){if(-1===response.deletedContractUserId)return confirmContractUserDeletionModal.modal("hide"),errorModalContent.html(`<p class="text-center">${response.message}</p>`),void errorModal.modal("show");window.location.reload()})).fail((function(error){console.error(error)}))}))},handleViewUserProfileButtonClick=()=>{viewUserProfileButton.click((()=>{window.open(selectedUser.profileUrl,"blank")}))},handleCreateContractButtonClick=()=>{createContractButton.click((()=>{window.location.href=`/local/grupomakro_core/pages/createcontractinstitutional.php?id=${selectedInstitutionId}`}))},handleRemoveContractButtonClick=()=>{removeContractButtons.click((event=>{selectedContractId=event.currentTarget.attributes["contract-id"].value}))},handleRemoveContractConfirmButtonClick=()=>{removeContractConfirmButton.click((()=>{const args={id:selectedContractId};Ajax.call([{methodname:"local_grupomakro_delete_institution_contract",args:args}])[0].done((function(response){if(-1===response.deletedInstitutionContractId)return confirmContractDeletionModal.modal("hide"),errorModalContent.html(`<p class="text-center">${response.message}</p>`),void errorModal.modal("show");window.location.reload()})).fail((function(error){console.error(error)}))}))},handleViewUserDetailsButton=()=>{viewUserDetailsButtons.click((event=>{selectedUser=selectedInstitutionContractUsers[event.currentTarget.attributes["contract-user-id"].value],userInfoName.text(selectedUser.fullname),userInfoName.attr("href",selectedUser.profileUrl),userInfoEmail.text(selectedUser.email),userInfoAvatar.attr("src",selectedUser.avatar);let contractsHtmlString="";selectedUser.contracts.forEach((contract=>{contractsHtmlString+=`\n            <li class="list-group-item d-flex justify-content-between align-items-center">\n                <div class="contracicon d-flex align-items-center">\n                    <img class="icon " alt="" aria-hidden="true" src="${contractIcon}">\n                    <span class="ml-2">${contract.contractId}</span>\n                    <span class="ml-2">${contract.courseName}</span>\n                </div>\n                <a href="#" class="text-secondary delete-contract-user-link" contract-user-id="${contract.id}">\n                    <i class="fa fa-trash" style="font-size:20px"></i>\n                </a>\n            </li>`})),userInfoContractList.html(contractsHtmlString),handleDeleteUserContractLinkButtonClick()}))}}));

//# sourceMappingURL=institutional_contracts.min.js.map