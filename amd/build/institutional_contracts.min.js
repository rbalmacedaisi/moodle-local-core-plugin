function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("local_grupomakro_core/institutional_contracts",["exports","core/ajax","jquery"],(function(_exports,Ajax,_jquery){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,Ajax=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Ajax);var selectedInstitutionId,selectedContractId,selectedUser,selectedInstitutionContractUsers,availableUsers,selectedUserToBeCreated,selectedContractUserId,generatedEnrolLinkUrl,bulkFile,createContractButton=(0,(_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj}).default)("#create-contract-button"),removeContractButtons=(0,_jquery.default)(".remove-contract"),removeContractConfirmButton=(0,_jquery.default)("#remove-contract-confirm-button"),confirmContractDeletionModal=(0,_jquery.default)("#confirmContractDeletionModal"),viewUserDetailsButtons=(0,_jquery.default)(".view-details-button"),userInfoName=(0,_jquery.default)("#user-info-name"),userInfoEmail=(0,_jquery.default)("#user-info-email"),userInfoAvatar=(0,_jquery.default)("#user-info-avatar"),viewUserProfileButton=(0,_jquery.default)("#view-profile-button"),userInfoContractList=(0,_jquery.default)("#user-info-contract-list"),confirmContractUserDeletionModal=(0,_jquery.default)("#confirmContractUserDeletionModal"),confirmContractUserDeletionButton=(0,_jquery.default)("#remove-contract-user-confirm-button"),selectedUserInput=(0,_jquery.default)("#selected-user"),contractSelectInput=(0,_jquery.default)("#contractlist"),coursesSelectInput=(0,_jquery.default)("#courselist"),newContractUserInputs=[selectedUserInput,contractSelectInput,coursesSelectInput],addUserButton=(0,_jquery.default)("#add-user-button"),generateEnrolLinkModal=(0,_jquery.default)("#generateEnrolLinkModal"),enrolLinkContractListSelect=(0,_jquery.default)("#enrolLinkContractList"),enrolLinkCourseListSelect=(0,_jquery.default)("#enrolLinkCourseList"),enrolLinkInputs=[enrolLinkContractListSelect,enrolLinkCourseListSelect],enrolLinkGenerateButton=(0,_jquery.default)("#generate-enrol-button"),genetaredLinkInfoModal=(0,_jquery.default)("#generatedLinkInfoModal"),enrolLinkExpirationDateContainer=(0,_jquery.default)("#enrolLinkExpirationDate"),enrolLinkUrlContainer=(0,_jquery.default)("#enrolLinkUrl"),enrolUrlClipboardCopyButton=(0,_jquery.default)("#enrolUrlClipboardCopy"),bulkUserContractInput=(0,_jquery.default)("#upload_massive_inst_users"),bulkConfirmModal=(0,_jquery.default)("#bulkConfirmModal"),bulkConfirmModalButton=(0,_jquery.default)("#bulkConfirmModalButton"),bulkCancelModalButton=(0,_jquery.default)("#bulkCancelModalButton"),bulkReportModal=(0,_jquery.default)("#bulkReportModal"),bulkResultTableBody=(0,_jquery.default)("#bulkResultTableBody"),bulkReportContinueButton=(0,_jquery.default)("#bulk-report-continue"),contractSearch=(0,_jquery.default)("#contract-search"),contractUserSearch=(0,_jquery.default)("#contract-user-search"),contractApplyFilterButton=(0,_jquery.default)("#contract-apply-filter-button"),userContractApplyFilterButton=(0,_jquery.default)("#user-contract-apply-filter-button"),contractRemoveFilterButton=(0,_jquery.default)("#contract-remove-filter-button"),userContractRemoveFilterButton=(0,_jquery.default)("#user-contract-remove-filter-button"),contractIcon=window.location.href+"/theme/image.php?theme=soluttolmsadmin&amp;component=local_grupomakro_core&amp;image=t%2Fcontract",errorModal=(0,_jquery.default)("#errorModal"),errorModalContent=(0,_jquery.default)("#error-modal-content");_exports.init=function(institutionId,institutionContractUsers,users,contractNames){selectedInstitutionContractUsers=institutionContractUsers,selectedInstitutionId=institutionId,availableUsers=users,contractNames,handleCreateContractButtonClick(),handleRemoveContractButtonClick(),handleRemoveContractConfirmButtonClick(),handleRemoveContractUserConfirmButtonClick(),handleViewUserDetailsButton(),handleViewUserProfileButtonClick(),handleDeleteUserContractLinkButtonClick(),handleUserCreation(),handleEnrolLinkGenerateButtonClick(),handleEnrolUrlClipboardCopyButton(),handleBulkContractUserInput(),handleAddFilters(),handleRemoveFilters()};var handleRemoveFilters=function(){contractRemoveFilterButton.click((function(){var contractUserFilter=new URLSearchParams(window.location.search).get("contractUserFilter");window.location.href="/local/grupomakro_core/pages/institutionalcontracts.php?id=".concat(selectedInstitutionId).concat(contractUserFilter?"&contractUserFilter=".concat(contractUserFilter):"")})),userContractRemoveFilterButton.click((function(){var contractFilter=new URLSearchParams(window.location.search).get("contractFilter");window.location.href="/local/grupomakro_core/pages/institutionalcontracts.php?id=".concat(selectedInstitutionId).concat(contractFilter?"&contractFilter=".concat(contractFilter):"","#users")}))},handleAddFilters=function(){contractApplyFilterButton.click((function(){var contractUserFilter=new URLSearchParams(window.location.search).get("contractUserFilter");window.location.href="/local/grupomakro_core/pages/institutionalcontracts.php?id=".concat(selectedInstitutionId,"&contractFilter=").concat(contractSearch.val()).concat(contractUserFilter?"&contractUserFilter=".concat(contractUserFilter):"")})),userContractApplyFilterButton.click((function(){var contractFilter=new URLSearchParams(window.location.search).get("contractFilter");window.location.href="/local/grupomakro_core/pages/institutionalcontracts.php?id=".concat(selectedInstitutionId,"&contractUserFilter=").concat(contractUserSearch.val()).concat(contractFilter?"&contractFilter=".concat(contractFilter):"","#users")}))},handleBulkContractUserInput=function(){var fn;bulkReportContinueButton.click((function(){window.location.reload()})),bulkUserContractInput.on("change",(function(event){bulkFile=event.target.files[0],bulkConfirmModal.modal("show"),console.log(bulkFile)})),bulkConfirmModalButton.click((fn=regeneratorRuntime.mark((function _callee(){var formData,fetchParams,bulkCSVUploadResponse,args,bulkEnrolResponse,bulkResults,bulkResultTableRowsHtmlString;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return(formData=new FormData).append("file",bulkFile),formData.append("token","33513bec0b3469194c7756c29bf9fb33"),fetchParams={method:"POST",body:formData},_context.prev=4,_context.next=7,window.fetch("".concat(window.location.href,"/webservice/upload.php"),fetchParams);case 7:if((bulkCSVUploadResponse=_context.sent).ok){_context.next=10;break}throw new Error("Request failed with status: "+bulkCSVUploadResponse.status);case 10:return _context.next=12,bulkCSVUploadResponse.json();case 12:return bulkCSVUploadResponse=(bulkCSVUploadResponse=_context.sent)[0],args={contextId:bulkCSVUploadResponse.contextid,itemId:bulkCSVUploadResponse.itemid,filename:bulkCSVUploadResponse.filename},_context.next=17,Ajax.call([{methodname:"local_grupomakro_bulk_create_contract_user",args:args}])[0];case 17:if((bulkEnrolResponse=_context.sent).result){_context.next=20;break}throw bulkEnrolResponse.message;case 20:bulkResults=JSON.parse(bulkEnrolResponse.result),console.log(bulkResults),bulkConfirmModal.modal("hide"),bulkReportModal.modal("show"),bulkResultTableRowsHtmlString="",bulkResults.errors.forEach((function(record){bulkResultTableRowsHtmlString+='<tr class="inserted-error">\n                      <th scope="row">'.concat(record.index,"</th>\n                      <td>").concat(record.error,"</td>\n                    </tr>")})),bulkResultTableBody.html(bulkResultTableRowsHtmlString),_context.next=34;break;case 29:_context.prev=29,_context.t0=_context.catch(4),errorModalContent.html('<p class="text-center">'.concat(_context.t0,"</p>")),errorModal.modal("show"),console.error(_context.t0);case 34:return _context.prev=34,_context.abrupt("return");case 37:case"end":return _context.stop()}}),_callee,null,[[4,29,34,37]])})),function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))})),bulkCancelModalButton.click((function(){bulkConfirmModal.modal("hide"),bulkFile=void 0}))},handleEnrolUrlClipboardCopyButton=function(){enrolUrlClipboardCopyButton.click((function(){window.navigator.clipboard.writeText(generatedEnrolLinkUrl),window.alert("Se ha copiado la url")}))},handleEnrolLinkGenerateButtonClick=function(){enrolLinkGenerateButton.click((function(){if(enrolLinkInputs.every((function(input){return input.get(0).reportValidity()}))){var args={contractId:enrolLinkContractListSelect.val(),courseId:enrolLinkCourseListSelect.val()};Ajax.call([{methodname:"local_grupomakro_generate_contract_enrol_link",args:args}])[0].done((function(response){if("-1"===response.contractEnrolLink)return errorModalContent.html('<p class="text-center">'.concat(response.message,"</p>")),void errorModal.modal("show");generateEnrolLinkModal.modal("hide"),enrolLinkExpirationDateContainer.text(response.expirationDate),enrolLinkUrlContainer.text(response.contractEnrolLink),generatedEnrolLinkUrl=response.contractEnrolLink,genetaredLinkInfoModal.modal("show")})).fail((function(error){console.error(error)}))}}))},handleUserCreation=function(){addUserButton.click((function(){if(selectedUserInput.get(0).setCustomValidity(""),newContractUserInputs.every((function(input){return input.get(0).reportValidity()}))){if(!selectedUserToBeCreated)return selectedUserInput.get(0).setCustomValidity("Este usuario no existe."),void selectedUserInput.get(0).reportValidity();var args={userId:selectedUserToBeCreated.id,contractId:contractSelectInput.val(),courseIds:coursesSelectInput.val().join(",")};Ajax.call([{methodname:"local_grupomakro_create_contract_user",args:args}])[0].done((function(response){response.result||(errorModalContent.html('<p class="text-center">'.concat(response.message,"</p>")),errorModal.modal("show"));var parsedResponse=JSON.parse(response.result);if(console.log(parsedResponse),!parsedResponse.success.length)return errorModalContent.html('<p class="text-center">'.concat(parsedResponse.failure[0].message,"</p>")),void errorModal.modal("show");window.location.reload()})).fail((function(error){console.error(error)}))}})),selectedUserInput.on("input",(function(){(selectedUserToBeCreated=availableUsers.find((function(user){return user.username===selectedUserInput.val()})))?contractSelectInput.removeAttr("disabled"):contractSelectInput.prop("disabled",!0)}))},handleDeleteUserContractLinkButtonClick=function(){(0,_jquery.default)(".delete-contract-user-link").click((function(event){selectedContractUserId=event.currentTarget.attributes["contract-user-id"].value,confirmContractUserDeletionModal.modal("show")}))},handleRemoveContractUserConfirmButtonClick=function(){confirmContractUserDeletionButton.click((function(){if(selectedContractUserId){var args={id:selectedContractUserId};Ajax.call([{methodname:"local_grupomakro_delete_contract_user",args:args}])[0].done((function(response){if(-1===response.deletedContractUserId)return confirmContractUserDeletionModal.modal("hide"),errorModalContent.html('<p class="text-center">'.concat(response.message,"</p>")),void errorModal.modal("show");window.location.reload()})).fail((function(error){console.error(error)}))}}))},handleViewUserProfileButtonClick=function(){viewUserProfileButton.click((function(){window.open(selectedUser.profileUrl,"blank")}))},handleCreateContractButtonClick=function(){createContractButton.click((function(){window.location.href="/local/grupomakro_core/pages/createcontractinstitutional.php?id=".concat(selectedInstitutionId)}))},handleRemoveContractButtonClick=function(){removeContractButtons.click((function(event){selectedContractId=event.currentTarget.attributes["contract-id"].value}))},handleRemoveContractConfirmButtonClick=function(){removeContractConfirmButton.click((function(){var args={id:selectedContractId};Ajax.call([{methodname:"local_grupomakro_delete_institution_contract",args:args}])[0].done((function(response){if(-1===response.deletedInstitutionContractId)return confirmContractDeletionModal.modal("hide"),errorModalContent.html('<p class="text-center">'.concat(response.message,"</p>")),void errorModal.modal("show");window.location.reload()})).fail((function(error){console.error(error)}))}))},handleViewUserDetailsButton=function(){viewUserDetailsButtons.click((function(event){selectedUser=selectedInstitutionContractUsers[event.currentTarget.attributes["contract-user-id"].value],userInfoName.text(selectedUser.fullname),userInfoName.attr("href",selectedUser.profileUrl),userInfoEmail.text(selectedUser.email),userInfoAvatar.attr("src",selectedUser.avatar);var contractsHtmlString="";selectedUser.contracts.forEach((function(contract){contractsHtmlString+='\n            <li class="list-group-item d-flex justify-content-between align-items-center">\n                <div class="contracicon d-flex align-items-center">\n                    <img class="icon " alt="" aria-hidden="true" src="'.concat(contractIcon,'">\n                    <span class="ml-2">').concat(contract.contractId,'</span>\n                    <span class="ml-2">').concat(contract.courseName,'</span>\n                </div>\n                <a href="#" class="text-secondary delete-contract-user-link" contract-user-id="').concat(contract.id,'">\n                    <i class="fa fa-trash" style="font-size:20px"></i>\n                </a>\n            </li>')})),userInfoContractList.html(contractsHtmlString),handleDeleteUserContractLinkButtonClick()}))}}));

//# sourceMappingURL=institutional_contracts.min.js.map