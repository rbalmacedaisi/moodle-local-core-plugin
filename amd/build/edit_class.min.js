define("local_grupomakro_core/edit_class",["exports","core/ajax","jquery"],(function(_exports,Ajax,_jquery){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,Ajax=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Ajax);const classNameInput=(0,(_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj}).default)("#classname"),typeSelector=(0,_jquery.default)("#class_type"),careerSelector=(0,_jquery.default)("#career"),periodSelector=(0,_jquery.default)("#period"),courseSelector=(0,_jquery.default)("#courses"),teacherSelector=(0,_jquery.default)("#instructor"),initTimeInput=(0,_jquery.default)("#starttime"),endTimeInput=(0,_jquery.default)("#endtime"),newDateInput=(0,_jquery.default)("#newDate"),newStartTimeInput=(0,_jquery.default)("#newStartTime"),newEndTimeInput=(0,_jquery.default)("#newEndTime"),saveButton=(0,_jquery.default)("#saveClassButton"),rescheduleButton=(0,_jquery.default)("#rescheduleActivityButton"),confirmRescheduleButton=(0,_jquery.default)("#confirmRescheduleActivity"),cancelRescheduleButton=(0,_jquery.default)("#cancelRescheduleActivity"),mondaySwitch=(0,_jquery.default)("#customSwitchMonday"),tuesdaySwitch=(0,_jquery.default)("#customSwitchTuesday"),wednesdaySwitch=(0,_jquery.default)("#customSwitchWednesday"),thursdaySwitch=(0,_jquery.default)("#customSwitchThursday"),fridaySwitch=(0,_jquery.default)("#customSwitchFriday"),saturdaySwitch=(0,_jquery.default)("#customSwitchSaturday"),sundaySwitch=(0,_jquery.default)("#customSwitchSunday"),rescheduleConfirmationText=(0,_jquery.default)("#confirmationTextHolder"),rescheduleModal=(0,_jquery.default)("#rescheduleActivityModalCenter"),errorModal=(0,_jquery.default)("#errorModal"),errorModalContent=(0,_jquery.default)("#error-modal-content"),selectors=[classNameInput,typeSelector,careerSelector,periodSelector,courseSelector,teacherSelector,initTimeInput,endTimeInput],switches=[mondaySwitch,tuesdaySwitch,wednesdaySwitch,thursdaySwitch,fridaySwitch,saturdaySwitch,sundaySwitch],classId=window.location.search.substring(10);let periods,courses,teachers;_exports.init=()=>{handleCareerSelection(),handlePeriodSelection(),handleCourseSelection(),handleClassSave(),handleActivityReschedule(),handleActivityRescheduleConfirmation(),handleActivityRescheduleCancelation()};const handleActivityRescheduleCancelation=()=>{cancelRescheduleButton.click((()=>{rescheduleConfirmationText.html("<p>Verificando disponibilidad...</p>"),confirmRescheduleButton.show()}))},handleActivityRescheduleConfirmation=()=>{confirmRescheduleButton.click((()=>{const searchParams=new URLSearchParams(window.location.search),args={classId:searchParams.get("class_id"),moduleId:searchParams.get("moduleId"),date:newDateInput.val(),initTime:newStartTimeInput.val(),endTime:newEndTimeInput.val(),sessionId:""!==searchParams.get("sessionId")?searchParams.get("sessionId"):null};rescheduleConfirmationText.html("<p>Reprogramando actividad...</p>"),confirmRescheduleButton.prop("disabled",!0),cancelRescheduleButton.prop("disabled",!0);Ajax.call([{methodname:"local_grupomakro_reschedule_activity",args:args}])[0].done((function(response){if(window.console.log(response),-1===response.status)return rescheduleConfirmationText.html(`<p>${response.message}</p>`),confirmRescheduleButton.prop("disabled",!1),void cancelRescheduleButton.prop("disabled",!1);rescheduleConfirmationText.html("<p>Todo listo, Redirigiendo al calendario...</p>"),window.location.href="/local/grupomakro_core/pages/schedules.php"})).fail((function(error){window.console.error(error)}))}))},handleActivityReschedule=()=>{rescheduleButton.click((()=>!(newStartTimeInput.val()>=newEndTimeInput.val())||(newEndTimeInput.get(0).setCustomValidity("La hora de finalización debe ser mayor a la hora de inicio."),newEndTimeInput.get(0).reportValidity(),!1))),rescheduleModal.on("show.bs.modal",(function(){const searchParams=new URLSearchParams(window.location.search),args={classId:searchParams.get("class_id"),moduleId:searchParams.get("moduleId"),date:newDateInput.val(),initTime:newStartTimeInput.val(),endTime:newEndTimeInput.val(),sessionId:""!==searchParams.get("sessionId")?searchParams.get("sessionId"):null};confirmRescheduleButton.hide();return Ajax.call([{methodname:"local_grupomakro_check_reschedule_conflicts",args:args}])[0].done((function(response){window.console.log(response),rescheduleConfirmationText.html(`<p>${response.message}</p>`),-1!==response.status&&confirmRescheduleButton.show()})).fail((function(error){window.console.error(error)})),!0}))},handleClassSave=()=>{saveButton.click((()=>{endTimeInput.get(0).setCustomValidity("");if(!selectors.every((selector=>selector.get(0).reportValidity())))return;if(initTimeInput.val()>=endTimeInput.val())return endTimeInput.get(0).setCustomValidity("La hora de finalización debe ser mayor a la hora de inicio."),void endTimeInput.get(0).reportValidity();if(!switches.some((day=>day.is(":checked"))))return mondaySwitch.get(0).setCustomValidity("Se debe seleccionar al menos un día de clase."),void mondaySwitch.get(0).reportValidity();const args={classId:classId,name:classNameInput.val(),type:typeSelector.val(),learningPlanId:careerSelector.val(),periodId:periodSelector.val(),courseId:courseSelector.val(),instructorId:teacherSelector.val(),initTime:initTimeInput.val(),endTime:endTimeInput.val(),classDays:formatSelectedClassDays()};Ajax.call([{methodname:"local_grupomakro_update_class",args:args}])[0].done((function(response){if(window.console.log(response),-1===response.status)try{const errorMessages=JSON.parse(response.message);let errorHTMLString="";errorMessages.forEach((message=>{errorHTMLString+=`<p class="text-center">${message}</p>`})),errorModalContent.html(errorHTMLString)}catch(error){errorModalContent.html(`<p class="text-center">${response.message}</p>`)}finally{errorModal.modal("show")}window.location.href="/local/grupomakro_core/pages/classmanagement.php"})).fail((function(error){window.console.error(error)}))}))},handleCareerSelection=()=>{careerSelector.change((()=>{if(""===careerSelector.val())return;const args={learningPlanId:careerSelector.val()};Ajax.call([{methodname:"local_sc_learningplans_get_learning_plan_periods",args:args}])[0].done((function(response){(0,_jquery.default)(".periodValue").remove(),(0,_jquery.default)(".courseValue").remove(),(0,_jquery.default)(".teacherValue").remove(),periods=JSON.parse(response.periods),periods.length?periods.forEach((_ref=>{let{id:id,name:name}=_ref;periodSelector.append(`<option class="periodValue" value="${id}">${name}</option>`)})):periodSelector.val("").change()})).fail((function(response){window.console.error(response)}))}))},handlePeriodSelection=()=>{periodSelector.change((()=>{if(""===periodSelector.val())return;const args={learningPlanId:careerSelector.val(),periodId:periodSelector.val()};Ajax.call([{methodname:"local_sc_learningplans_get_learning_plan_courses",args:args}])[0].done((function(response){(0,_jquery.default)(".courseValue").remove(),(0,_jquery.default)(".teacherValue").remove(),courses=JSON.parse(response.courses),courses.length?courses.forEach((_ref2=>{let{id:id,name:name}=_ref2;courseSelector.append(`<option class="courseValue" value="${id}">${name}</option>`)})):courseSelector.val("").change()})).fail((function(response){window.console.error(response)}))}))},handleCourseSelection=()=>{courseSelector.change((()=>{get_potential_teachers()}))},formatSelectedClassDays=()=>{let daysString="";return switches.forEach((day=>{daysString+=(day.is(":checked")?1:0)+"/"})),daysString.substring(0,daysString.length-1)},get_potential_teachers=()=>{if(!courseSelector.val()||!initTimeInput.val()||!endTimeInput.val())return;if(!switches.some((day=>day.is(":checked"))))return;const args={courseId:courseSelector.val(),initTime:initTimeInput.val(),endTime:endTimeInput.val(),classDays:formatSelectedClassDays()};Ajax.call([{methodname:"local_grupomakro_get_potential_class_teachers",args:args}])[0].done((function(response){window.console.log(response),(0,_jquery.default)(".teacherValue").remove(),teachers=JSON.parse(response.teachers),teachers.length?(teacherSelector.prop("disabled",!1),teachers.forEach((_ref3=>{let{userid:userid,fullname:fullname,email:email}=_ref3;teacherSelector.append(`<option class="teacherValue" value="${userid}">${fullname} (${email})</option>`)}))):teacherSelector.val("").change()})).fail((function(response){window.console.error(response)}))}}));

//# sourceMappingURL=edit_class.min.js.map